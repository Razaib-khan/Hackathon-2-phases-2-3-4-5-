name: Deploy to Kubernetes

on:
  workflow_run:
    workflows: ["CI/CD Pipeline for AIDO TODO Application"]
    types:
      - completed
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Setup Kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'latest'

    - name: Set up Helm
      uses: azure/setup-helm@v3
      with:
        version: 'latest'

    - name: Configure kubectl
      run: |
        mkdir -p ~/.kube
        echo "${{ secrets.KUBECONFIG_DATA }}" | base64 -d > ~/.kube/config

    - name: Deploy to Kubernetes
      run: |
        # Deploy using Helm
        helm upgrade --install todo-chatbot ./charts/todo-chatbot \
          --namespace todo-app \
          --create-namespace \
          --set backend.image.repository=${{ secrets.DOCKER_USERNAME }}/todo-backend \
          --set backend.image.tag=${{ github.sha }} \
          --set frontend.image.repository=${{ secrets.DOCKER_USERNAME }}/todo-frontend \
          --set frontend.image.tag=${{ github.sha }} \
          --wait \
          --timeout=10m

    - name: Verify deployment
      run: |
        kubectl get pods -n todo-app
        kubectl get services -n todo-app
        kubectl rollout status deployment/todo-chatbot-backend -n todo-app
        kubectl rollout status deployment/todo-chatbot-frontend -n todo-app